import React, { useState, useEffect } from 'react';
import logoCicopal from './assets/logo-cicopal.png';
import axios from 'axios';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { 
  ChevronDown, Plus, Server, Menu, Calendar, Clock, AlertTriangle, CheckCircle, X, 
  UploadCloud, FileText, Copy, Edit2, Paperclip, ClipboardList, Loader2, ArrowRight, Building, Users, LogOut, UserPlus, Lock, Trash2, Save, ChevronLeft, ChevronRight
} from 'lucide-react';

const API_URL = (import.meta.env.VITE_API_URL || "http://127.0.0.1:8000").replace(/\/$/, "");

const CORES = { amareloSnack: '#F9C531', azulProfundo: '#1A2A6C', azulVibrante: '#2196F3', vermelhoCrocante: '#D62828', laranjaDoce: '#F77F00' };
const CLEAN_PANEL = "bg-white/95 backdrop-blur-sm border border-white/50 shadow-xl rounded-2xl";
const INPUT_STYLE = "w-full bg-slate-50 border border-slate-200 p-3 rounded-xl text-slate-800 font-bold focus:bg-white focus:border-[#2196F3] focus:ring-2 focus:ring-blue-100 outline-none transition-all placeholder:text-slate-400";
const LABEL_STYLE = "text-[11px] font-black uppercase text-[#1A2A6C] tracking-widest mb-1.5 block ml-1";
const BUTTON_PRIMARY = "bg-gradient-to-r from-[#1A2A6C] to-[#2196F3] hover:scale-105 text-white font-black px-6 py-3 rounded-xl shadow-xl shadow-blue-500/30 transition-all active:scale-95 flex items-center justify-center gap-2 uppercase tracking-wider text-sm";

const STATUS_STYLES = {
  'Aguardando Fatura': { bg: 'bg-[#F9C531]/10', border: 'border-[#F9C531]', text: 'text-amber-600', icon: <Clock/> },
  'Pendente Lan√ßamento': { bg: 'bg-[#D62828]/10', border: 'border-[#D62828]', text: 'text-[#D62828]', icon: <AlertTriangle/> },
  'Aguardando Pagamento': { bg: 'bg-[#2196F3]/10', border: 'border-[#2196F3]', text: 'text-[#2196F3]', icon: <Calendar/> },
  'Conclu√≠da': { bg: 'bg-emerald-50', border: 'border-emerald-500', text: 'text-emerald-600', icon: <CheckCircle/> },
};
const OPCOES_STATUS = ['Aguardando Fatura', 'Pendente Lan√ßamento', 'Aguardando Pagamento', 'Conclu√≠da'];

const LoginScreen = ({ onLogin }) => {
  const [username, setUsername] = useState(''); const [password, setPassword] = useState(''); const [error, setError] = useState(''); const [loading, setLoading] = useState(false);
  const handleSubmit = async (e) => { e.preventDefault(); setLoading(true); setError(''); const fd = new FormData(); fd.append('username', username); fd.append('password', password); try { const res = await axios.post(`${API_URL}/token`, fd); onLogin(res.data.access_token); } catch { setError('Credenciais inv√°lidas'); } finally { setLoading(false); } };
  return (
    <div className="min-h-screen bg-gradient-to-br from-[#1A2A6C] to-[#2196F3] flex items-center justify-center p-4">
      <div className="bg-white/95 backdrop-blur-xl p-8 rounded-3xl shadow-2xl w-full max-w-md border border-white/50 text-center">
        <div className="bg-[#F9C531] w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg text-[#1A2A6C]"><Server size={32}/></div>
        <h1 className="text-3xl font-black text-[#1A2A6C] mb-8">CICOPAL <span className="font-light">GEST√ÉO DE NOTAS</span></h1>
        <form onSubmit={handleSubmit} className="space-y-6">
          <input className={INPUT_STYLE} value={username} onChange={e => setUsername(e.target.value)} placeholder="Usu√°rio" autoFocus/>
          <input type="password" className={INPUT_STYLE} value={password} onChange={e => setPassword(e.target.value)} placeholder="Senha"/>
          {error && <p className="text-red-500 text-xs font-bold">{error}</p>}
          <button type="submit" className={`w-full ${BUTTON_PRIMARY}`} disabled={loading}>{loading ? <Loader2 className="animate-spin"/> : <Lock size={18}/>} ENTRAR</button>
        </form>
      </div>
    </div>
  );
};

const FileDrop = ({ label, onFileSelect, existingFile, metaData, colorTheme = "blue" }) => {
  const [fileName, setFileName] = useState(existingFile ? existingFile.split('/').pop() : null);
  useEffect(() => { setFileName(existingFile ? existingFile.split('/').pop() : null); }, [existingFile]);
  const handleFile = async (e) => {
    const file = e.target.files[0]; if (!file) return;
    if (!metaData.fornecedor || !metaData.nota) return alert("Selecione Fornecedor e Nota antes.");
    setFileName(file.name); const fd = new FormData(); fd.append("file", file); fd.append("fornecedor", metaData.fornecedor); fd.append("nota", metaData.nota); fd.append("vencimento", metaData.vencimento || "S_D");
    try { const res = await axios.post(`${API_URL}/upload/`, fd); onFileSelect(res.data.path); } catch { alert("Erro upload"); }
  };
  const theme = colorTheme === 'red' ? 'border-[#D62828] text-[#D62828] bg-red-50' : 'border-[#2196F3] text-[#2196F3] bg-blue-50';
  return (<div className="w-full"><label className={LABEL_STYLE}>{label}</label><div className={`relative border-2 border-dashed rounded-xl p-2 hover:bg-white transition-all text-center cursor-pointer group h-[80px] flex flex-col items-center justify-center ${theme}`}><input type="file" className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onChange={handleFile} accept=".pdf,.png,.jpg"/><div className="flex flex-col items-center justify-center gap-1">{fileName ? <CheckCircle size={24}/> : <UploadCloud size={24}/>}<span className="text-[10px] font-bold uppercase truncate max-w-[180px]">{fileName || "Arrastar Arquivo"}</span></div></div></div>);
};

const KpiCard = ({ title, count, colorHex, icon, isActive, onClick }) => (
  <div onClick={onClick} className={`bg-white p-6 border-l-[6px] rounded-2xl shadow-sm transition-all duration-200 group relative overflow-hidden cursor-pointer select-none ${isActive ? 'ring-2 ring-[#1A2A6C] -translate-y-1' : 'hover:-translate-y-1 hover:shadow-md'}`} style={{ borderColor: colorHex }}>
    {isActive && <div className="absolute top-3 right-3 text-[#1A2A6C]"><CheckCircle size={20} fill="#F9C531"/></div>}
    <div className="absolute -right-6 -bottom-6 opacity-10 group-hover:opacity-20 transition-opacity transform rotate-12 scale-[2.5]" style={{ color: colorHex }}>{icon}</div>
    <div className="relative z-10"><p className={`text-[11px] font-black uppercase tracking-widest mb-2 ${isActive ? 'text-[#1A2A6C]' : 'text-slate-400'}`}>{title}</p><p className="text-4xl font-black text-[#1A2A6C] tracking-tighter">{count}</p></div>
  </div>
);

export default function ITFinControl() {
  const queryClient = useQueryClient();
  const [token, setToken] = useState(localStorage.getItem('token'));
  const [currentView, setCurrentView] = useState('dashboard');
  const [isMenuOpen, setIsMenuOpen] = useState(false);
  const authConfig = { headers: { Authorization: `Bearer ${token}` } };
  const [competencia, setCompetencia] = useState(new Date());

  const [filialFiltro, setFilialFiltro] = useState('');
  const [statusFiltro, setStatusFiltro] = useState([]);
  const [expandedMonth, setExpandedMonth] = useState(null);
  const [expandedSupplier, setExpandedSupplier] = useState({});
  const [showModal, setShowModal] = useState(false);
  const [isEditMode, setIsEditMode] = useState(false);
  
  const [editingFilial, setEditingFilial] = useState(null);
  const [editingFornecedor, setEditingFornecedor] = useState(null);
  const [opcoesFornecedor, setOpcoesFornecedor] = useState({ cnpjs: [], contratos: [], ccs: [] });
  const [formUser, setFormUser] = useState({ username: '', password: '', nome_completo: '', cpf: '', setor: '', cargo: '' });
  
  const initialForm = { id: null, filial_id: '', fornecedor_id: '', cnpj_usado: '', contrato_usado: '', centro_custo_usado: '', numero_nota: '', serie: 'U', valor: '', data_envio: '', data_vencimento: '', descricao_servico: '', servico_protheus: '', numero_medicao: '', numero_pedido: '', solicitacao_fluig: '', observacao: '', status_pagamento: 'Pendente Lan√ßamento', arquivo_nota: '', arquivo_boleto: '' };
  const [form, setForm] = useState(initialForm);

  const { data: filiais = [] } = useQuery({ queryKey: ['filiais'], queryFn: () => axios.get(`${API_URL}/filiais/`, authConfig).then(res => res.data), enabled: !!token });
  const { data: fornecedores = [] } = useQuery({ queryKey: ['fornecedores'], queryFn: () => axios.get(`${API_URL}/fornecedores/`, authConfig).then(res => res.data), enabled: !!token });
  const { data: dadosDashboard = [], isLoading: loadingDash } = useQuery({ queryKey: ['dashboard', filialFiltro, competencia.getMonth(), competencia.getFullYear()], queryFn: async () => { const params = { filial_id: filialFiltro || undefined, mes: competencia.getMonth() + 1, ano: competencia.getFullYear() }; const res = await axios.get(`${API_URL}/dados-agrupados/`, { ...authConfig, params }); let lista = []; res.data.forEach(forn => { if(forn.lancamentos) forn.lancamentos.forEach(nota => lista.push({ ...nota, nome_fornecedor: forn.nome_empresa })); }); return lista; }, enabled: !!token, keepPreviousData: true });
  const { data: usuarios = [], refetch: refetchUsuarios } = useQuery({ queryKey: ['usuarios'], queryFn: () => axios.get(`${API_URL}/usuarios/`, authConfig).then(res => res.data), enabled: !!token && currentView === 'usuarios' });

  const mutationLancamento = useMutation({ mutationFn: (nota) => nota.id ? axios.put(`${API_URL}/lancamentos/${nota.id}`, nota, authConfig) : axios.post(`${API_URL}/lancamentos/`, nota, authConfig), onSuccess: () => { queryClient.invalidateQueries(['dashboard']); setShowModal(false); } });
  const mutationStatus = useMutation({ mutationFn: ({id, status}) => axios.patch(`${API_URL}/lancamentos/${id}/status`, { status }, authConfig), onSuccess: () => queryClient.invalidateQueries(['dashboard']) });
  const mutationFilial = useMutation({ mutationFn: (data) => data.id ? axios.put(`${API_URL}/filiais/${data.id}`, data, authConfig) : axios.post(`${API_URL}/filiais/`, data, authConfig), onSuccess: () => { queryClient.invalidateQueries(['filiais']); setEditingFilial(null); } });
  const mutationFornecedor = useMutation({ mutationFn: (data) => data.id ? axios.put(`${API_URL}/fornecedores/${data.id}`, data, authConfig) : axios.post(`${API_URL}/fornecedores/`, data, authConfig), onSuccess: () => { queryClient.invalidateQueries(['fornecedores']); setEditingFornecedor(null); } });
  
  const handleLogin = (t) => { localStorage.setItem('token', t); setToken(t); };
  const handleLogout = () => { localStorage.removeItem('token'); setToken(null); queryClient.clear(); };
  const handleStatusFilter = (s) => setStatusFiltro(p => p.includes(s) ? p.filter(i => i !== s) : [...p, s]);
  const handleFornecedorChange = (id) => { const forn = fornecedores.find(f => f.id == id); if (forn) { setOpcoesFornecedor({ cnpjs: (forn.lista_cnpjs || '').split(';'), contratos: (forn.lista_contratos || '').split(';'), ccs: (forn.lista_centro_custos || '').split(';') }); setForm(p => ({ ...p, fornecedor_id: id, cnpj_usado: '', contrato_usado: '', centro_custo_usado: '', descricao_servico: forn.padrao_descricao_servico || '', servico_protheus: forn.padrao_servico_protheus || '' })); } else setForm(p => ({...p, fornecedor_id: id})); };
  const mudarMes = (delta) => { const novaData = new Date(competencia); novaData.setMonth(competencia.getMonth() + delta); setCompetencia(novaData); };

  const salvarForm = () => { if (!form.filial_id || !form.fornecedor_id || !form.valor || !form.numero_nota) return alert("Preencha obrigat√≥rios"); const payload = { ...form, data_envio: form.data_envio === '' ? null : form.data_envio }; mutationLancamento.mutate(payload); };
  const criarUsuario = async () => { if(!formUser.username) return alert("Preencha Login"); try { await axios.post(`${API_URL}/usuarios/`, formUser, authConfig); alert("Usu√°rio Criado!"); refetchUsuarios(); setFormUser({ username: '', password: '', nome_completo: '', cpf: '', setor: '', cargo: '' }); } catch { alert("Erro"); } };
  const duplicarNota = (nota) => { if(window.confirm("Deseja criar outra nota com base nessa?")) { setIsEditMode(false); handleFornecedorChange(nota.fornecedor_id); setTimeout(() => setForm({ ...nota, id: null, numero_nota: '', arquivo_nota: '', arquivo_boleto: '', data_envio: '', status_pagamento: 'Pendente Lan√ßamento' }), 50); setShowModal(true); } };
  const abrirEdicao = (nota) => { setIsEditMode(true); handleFornecedorChange(nota.fornecedor_id); setTimeout(() => setForm({...nota, data_envio: nota.data_envio || ''}), 50); setShowModal(true); };
  const getGroupedData = () => { const grupos = {}; const notas = statusFiltro.length ? dadosDashboard.filter(n => statusFiltro.includes(n.status_pagamento)) : dadosDashboard; notas.forEach(n => { if(!grupos[n.nome_fornecedor]) grupos[n.nome_fornecedor]=[]; grupos[n.nome_fornecedor].push(n); }); return Object.entries(grupos).sort((a,b) => a[0].localeCompare(b[0])); };
  const calcularDias = (venc) => Math.ceil((new Date(venc.split('-')[0], venc.split('-')[1]-1, venc.split('-')[2]) - new Date().setHours(0,0,0,0))/86400000);
  const getSemaforoClass = (venc, status) => { if (status === 'Conclu√≠da') return 'border-emerald-500 bg-emerald-50/10'; const dias = calcularDias(venc); if (dias < 0) return 'border-[#D62828] bg-red-50'; if (dias <= 5) return 'border-[#F77F00] bg-orange-50'; if (dias <= 10) return 'border-[#F9C531] bg-yellow-50'; return 'border-slate-200 bg-white'; };
  const getAlertBadge = (venc, status) => { if (status === 'Conclu√≠da') return <span className="bg-emerald-100 text-emerald-700 px-3 py-1.5 rounded-lg text-xs font-black flex items-center gap-2 w-fit"><CheckCircle size={16}/> CONCLU√çDO</span>; const dias = calcularDias(venc); if (dias < 0) return <span className="bg-[#1A2A6C] text-white px-3 py-1.5 rounded-lg text-xs font-black flex items-center gap-2 animate-pulse w-fit"><X size={16}/> VENCIDA H√Å {Math.abs(dias)} DIAS</span>; if (dias === 0) return <span className="bg-[#D62828] text-white px-3 py-1.5 rounded-lg text-xs font-black flex items-center gap-2 animate-bounce w-fit"><AlertTriangle size={16}/> HOJE!</span>; if (dias <= 5) return <span className="bg-[#F77F00] text-white px-3 py-1.5 rounded-lg text-xs font-black flex items-center gap-2 w-fit"><AlertTriangle size={16}/> CR√çTICO: {dias} DIAS</span>; return <span className="bg-blue-50 text-blue-500 border border-blue-200 px-3 py-1.5 rounded-lg text-xs font-black flex items-center gap-2 w-fit"><Clock size={16}/> VENCE EM {dias} DIAS</span>; };
  const copiarProtheus = (n) => navigator.clipboard.writeText(`${n.nome_fornecedor}${n.descricao_servico ? ': '+n.descricao_servico : ''} | CPF/CNPJ: ${n.cnpj_usado||'?'} | NF: ${n.numero_nota} | Valor R$: ${n.valor.toLocaleString('pt-BR',{minimumFractionDigits:2})} | Vencimento: ${n.data_vencimento.split('-').reverse().join('/')}`).then(()=>alert("Copiado!"));
  // --- DOWNLOAD ATUALIZADO PARA SUPABASE ---
  // Se come√ßar com http, √© link do Supabase. Se n√£o, √© arquivo legado (local).
  const downloadFile = (path) => { 
    if (!path) return;
    if (path.startsWith('http')) window.open(path, '_blank');
    else window.open(`${API_URL}/${path}`, '_blank');
  };
  const nomeFornecedorAtual = fornecedores.find(f => f.id == form.fornecedor_id)?.nome_empresa || "";
  const mesExibicao = competencia.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });

  if (!token) return <LoginScreen onLogin={handleLogin} />;

  return (
    <div className="min-h-screen bg-[#F0F2F5] font-sans text-slate-800 pb-40">
      {loadingDash && <div className="fixed inset-0 bg-white/80 z-[60] flex items-center justify-center"><Loader2 className="animate-spin text-[#1A2A6C]" size={48}/></div>}
      
      <header className="bg-gradient-to-r from-[#1A2A6C] to-[#2196F3] px-6 py-4 sticky top-0 z-40 flex justify-between items-center shadow-xl shadow-[#1A2A6C]/10"><div className="flex items-center gap-4"><button onClick={() => setIsMenuOpen(true)} className="text-white hover:bg-white/20 p-2 rounded-lg transition-colors"><Menu size={24}/></button><div className="text-white flex items-center gap-3"><div className="bg-white/20 p-2 rounded-lg border border-white/20"><Server size={22}/></div><div><h1 className="text-xl font-black tracking-tight leading-none">CICOPAL <span className="font-light opacity-80">GEST√ÉO DE NOTAS</span></h1></div></div></div><div className="flex gap-3 items-center">{currentView === 'dashboard' && <div className="relative group hidden md:block"><select className="appearance-none bg-black/20 border border-white/10 text-white font-bold text-sm rounded-lg px-4 py-2 pr-10 outline-none focus:bg-black/30 cursor-pointer transition-all" value={filialFiltro} onChange={e => setFilialFiltro(e.target.value)}><option value="" className="text-[#1A2A6C]">üè¢ Todas as Filiais</option>{filiais.map(f => <option key={f.id} value={f.id} className="text-[#1A2A6C]">{f.codigo} - {f.nome_fantasia}</option>)}</select><ChevronDown className="absolute right-3 top-3 text-white/70 pointer-events-none" size={14}/></div>}{currentView === 'dashboard' && <button onClick={() => { setForm(initialForm); setIsEditMode(false); setShowModal(true); }} className="bg-[#F9C531] text-[#1A2A6C] hover:bg-white px-5 py-2 rounded-lg font-black text-sm flex gap-2 items-center shadow-lg active:scale-95"><Plus size={18}/> LAN√áAR</button>}</div></header>
      <div className={`fixed inset-0 z-50 transition-all duration-300 ${isMenuOpen ? 'visible' : 'invisible'}`}><div className={`absolute inset-0 bg-[#1A2A6C]/80 backdrop-blur-sm transition-opacity duration-300 ${isMenuOpen ? 'opacity-100' : 'opacity-0'}`} onClick={() => setIsMenuOpen(false)}></div><div className={`absolute left-0 top-0 bottom-0 w-80 bg-white shadow-2xl p-6 transform transition-transform duration-300 flex flex-col ${isMenuOpen ? 'translate-x-0' : '-translate-x-full'}`}><div className="flex justify-between items-center mb-10 text-[#1A2A6C]"><h2 className="text-2xl font-black tracking-tighter">MENU</h2><button onClick={() => setIsMenuOpen(false)} className="hover:bg-slate-100 p-2 rounded-full"><X size={24}/></button></div><nav className="space-y-2 flex-1"><button onClick={() => { setCurrentView('dashboard'); setIsMenuOpen(false); }} className="w-full flex items-center gap-4 text-slate-600 font-bold p-4 rounded-xl hover:bg-slate-50 hover:translate-x-2 transition-all"><div className="bg-[#2196F3] p-2 rounded-lg text-white"><Server size={20}/></div>DASHBOARD</button><button onClick={() => { setCurrentView('filiais'); setIsMenuOpen(false); }} className="w-full flex items-center gap-4 text-slate-600 font-bold p-4 rounded-xl hover:bg-slate-50 hover:translate-x-2 transition-all"><div className="bg-[#2196F3] p-2 rounded-lg text-white"><Building size={20}/></div>FILIAIS</button><button onClick={() => { setCurrentView('fornecedores'); setIsMenuOpen(false); }} className="w-full flex items-center gap-4 text-slate-600 font-bold p-4 rounded-xl hover:bg-slate-50 hover:translate-x-2 transition-all"><div className="bg-[#2196F3] p-2 rounded-lg text-white"><Users size={20}/></div>FORNECEDORES</button><button onClick={() => { setCurrentView('usuarios'); refetchUsuarios(); setIsMenuOpen(false); }} className="w-full flex items-center gap-4 text-slate-600 font-bold p-4 rounded-xl hover:bg-slate-50 hover:translate-x-2 transition-all"><div className="bg-[#2196F3] p-2 rounded-lg text-white"><UserPlus size={20}/></div>USU√ÅRIOS</button></nav><button onClick={handleLogout} className="w-full flex items-center gap-4 text-red-500 font-bold p-4 rounded-xl hover:bg-red-50 hover:translate-x-2 transition-all mt-auto"><div className="bg-red-100 p-2 rounded-lg"><LogOut size={20}/></div>SAIR</button></div></div>

      <main className="max-w-[1600px] mx-auto p-6 space-y-10 mt-4">
        {currentView === 'dashboard' && (
          <>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4"><KpiCard title="Aguardando Fatura" count={dadosDashboard.filter(n=>n.status_pagamento==='Aguardando Fatura').length} colorHex={CORES.amareloSnack} icon={<Clock size={100}/>} isActive={statusFiltro.includes('Aguardando Fatura')} onClick={()=>handleStatusFilter('Aguardando Fatura')}/><KpiCard title="Pendente Lan√ßamento" count={dadosDashboard.filter(n=>n.status_pagamento==='Pendente Lan√ßamento').length} colorHex={CORES.vermelhoCrocante} icon={<AlertTriangle size={100}/>} isActive={statusFiltro.includes('Pendente Lan√ßamento')} onClick={()=>handleStatusFilter('Pendente Lan√ßamento')}/><KpiCard title="Aguardando Pagto" count={dadosDashboard.filter(n=>n.status_pagamento==='Aguardando Pagamento').length} colorHex={CORES.azulVibrante} icon={<Calendar size={100}/>} isActive={statusFiltro.includes('Aguardando Pagamento')} onClick={()=>handleStatusFilter('Aguardando Pagamento')}/><KpiCard title="Conclu√≠da" count={dadosDashboard.filter(n=>n.status_pagamento==='Conclu√≠da').length} colorHex="#10B981" icon={<CheckCircle size={100}/>} isActive={statusFiltro.includes('Conclu√≠da')} onClick={()=>handleStatusFilter('Conclu√≠da')}/></div>
            <div className="flex items-center justify-between bg-white p-4 rounded-2xl shadow-sm border border-slate-100"><button onClick={() => mudarMes(-1)} className="p-2 hover:bg-slate-100 rounded-full"><ChevronLeft/></button><div className="text-center"><h2 className="text-2xl font-black text-[#1A2A6C] uppercase">{mesExibicao}</h2><p className="text-xs text-slate-400 font-bold uppercase tracking-widest">Compet√™ncia Atual</p></div><button onClick={() => mudarMes(1)} className="p-2 hover:bg-slate-100 rounded-full"><ChevronRight/></button></div>
            <div className="space-y-4 pb-40">{getGroupedData().map(([nm, nts]) => { const exp = expandedSupplier[nm]; return (<div key={nm} className={`${CLEAN_PANEL} overflow-hidden transition-all duration-300`}><div onClick={()=>setExpandedSupplier(p=>({...p,[nm]:!p[nm]}))} className="px-6 py-4 flex justify-between items-center cursor-pointer hover:bg-slate-50 transition-colors"><div className="flex items-center gap-4"><div className="bg-[#1A2A6C]/5 p-2 rounded-lg text-[#1A2A6C]"><Server size={20}/></div><span className="font-bold text-lg text-[#1A2A6C] tracking-wide">{nm}</span></div><div className="flex items-center gap-3"><span className="text-xs font-bold bg-[#1A2A6C] text-white px-3 py-1 rounded-full shadow-sm">{nts.length}</span><div className={`p-1 rounded-full bg-slate-100 transition-transform duration-300 ${exp?'rotate-180':''}`}><ChevronDown size={18}/></div></div></div>{exp && <div className="bg-slate-50 p-4 grid gap-3 border-t border-slate-100">{nts.map(n => (<div key={n.id} className={`bg-white rounded-xl shadow-sm border-l-[6px] p-5 hover:shadow-md transition-all relative overflow-hidden group ${getSemaforoClass(n.data_vencimento, n.status_pagamento)}`}><div className="flex flex-col xl:flex-row justify-between gap-6 mb-4"><div className="flex gap-4"><div className="flex flex-col justify-center"><div className="flex items-center gap-3 mb-2"><span className="text-2xl font-black text-slate-800">#{n.numero_nota}</span><span className="text-[10px] font-bold bg-indigo-50 text-indigo-600 px-2 py-1 rounded border border-indigo-100 uppercase tracking-wide">{n.filial?.nome_fantasia || 'MATRIZ'}</span></div><div className="mb-4">{getAlertBadge(n.data_vencimento, n.status_pagamento)}</div><div className="flex flex-wrap gap-4"><div className="bg-slate-50 px-3 py-2 rounded-lg border border-slate-200"><span className="text-[10px] font-black uppercase text-slate-400 block tracking-wider">CNPJ</span><span className="text-lg font-black text-[#1A2A6C]">{n.cnpj_usado || '-'}</span></div><div className="bg-slate-50 px-3 py-2 rounded-lg border border-slate-200"><span className="text-[10px] font-black uppercase text-slate-400 block tracking-wider">CONTRATO</span><span className="text-lg font-black text-[#1A2A6C]">{n.contrato_usado || '-'}</span></div></div></div></div><div className="flex items-center gap-6"><div className="text-right"><p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-1">Valor Total</p><p className="text-3xl font-black text-[#1A2A6C]">R$ {n.valor.toLocaleString('pt-BR',{minimumFractionDigits:2})}</p></div><div className="flex gap-2 pl-6 border-l-2 border-slate-100 flex-col sm:flex-row"><button onClick={()=>copiarProtheus(n)} className="h-10 px-4 bg-[#1A2A6C] text-white rounded-lg font-bold text-xs flex items-center justify-center gap-2 hover:bg-[#2196F3] transition-colors shadow-sm" title="Copiar p/ Protheus"><ClipboardList size={16}/> Copiar</button><div className="flex gap-1">{n.arquivo_nota && <button onClick={()=>downloadFile(n.arquivo_nota)} className="h-10 w-10 bg-red-50 text-[#D62828] border border-red-100 rounded-lg hover:bg-[#D62828] hover:text-white transition-colors flex items-center justify-center" title="Ver Nota"><FileText size={18}/></button>}{n.arquivo_boleto && <button onClick={()=>downloadFile(n.arquivo_boleto)} className="h-10 w-10 bg-blue-50 text-[#2196F3] border border-blue-100 rounded-lg hover:bg-[#2196F3] hover:text-white transition-colors flex items-center justify-center" title="Ver Boleto"><Paperclip size={18}/></button>}</div><div className="flex gap-1"><button onClick={()=>abrirEdicao(n)} className="h-10 w-10 text-slate-400 hover:text-[#F77F00] bg-slate-100 rounded-lg transition-colors flex items-center justify-center" title="Editar"><Edit2 size={18}/></button><button onClick={()=>duplicarNota(n)} className="h-10 w-10 text-slate-400 hover:text-[#1A2A6C] bg-slate-100 rounded-lg transition-colors flex items-center justify-center" title="Duplicar"><Copy size={18}/></button></div></div></div></div><div className="grid grid-cols-2 md:grid-cols-5 gap-y-3 gap-x-6 text-sm text-slate-600 bg-slate-50 p-4 rounded-xl border border-slate-100"><div><strong className="block text-[#1A2A6C] uppercase text-[10px] font-black mb-1">Vencimento</strong><span className="text-base font-bold text-slate-600">{n.data_vencimento.split('-').reverse().join('/')}</span></div><div><strong className="block text-[#1A2A6C] uppercase text-[10px] font-black mb-1">Envio TI</strong><span className="text-base font-bold text-slate-600">{n.data_envio ? n.data_envio.split('-').reverse().join('/') : '-'}</span></div><div><strong className="block text-[#1A2A6C] uppercase text-[10px] font-black mb-1">Centro Custo</strong><span className="text-base font-bold text-slate-600">{n.centro_custo_usado || '-'}</span></div><div><strong className="block text-[#1A2A6C] uppercase text-[10px] font-black mb-1">Fluig</strong><span className="text-base font-bold text-slate-600">{n.solicitacao_fluig || '-'}</span></div><div className="relative"><strong className="block text-[#1A2A6C] uppercase text-[10px] font-black mb-1">Status Atual</strong><select value={n.status_pagamento} onChange={async (e) => { const st = e.target.value; mutationStatus.mutate({id: n.id, status: st}); }} className={`w-full appearance-none text-[11px] font-black uppercase py-1.5 px-3 rounded-lg border-2 cursor-pointer outline-none transition-all ${STATUS_STYLES[n.status_pagamento]?.bg} ${STATUS_STYLES[n.status_pagamento]?.border} ${STATUS_STYLES[n.status_pagamento]?.text}`}>{OPCOES_STATUS.map(s => <option key={s} value={s}>{s}</option>)}</select></div></div></div>))}</div>}</div>)})}</div > </>)}
        {/* FILIAIS E FORNECEDORES: MANTIDOS IGUAIS */}
        {currentView === 'filiais' && (<div className="bg-white rounded-3xl p-8 shadow-xl animate-in zoom-in-95"><div className="flex justify-between mb-6"><h2 className="text-3xl font-black text-[#1A2A6C] flex gap-3 items-center"><div className="bg-[#F9C531] p-2 rounded-lg text-white"><Building/></div> FILIAIS</h2><button onClick={()=>setEditingFilial({codigo:'', nome_fantasia:''})} className="bg-[#2196F3] text-white px-4 py-2 rounded-xl font-bold flex gap-2"><Plus size={18}/> Nova</button></div>{editingFilial && <div className="bg-slate-50 p-4 rounded-xl mb-4 border border-blue-200 grid grid-cols-2 gap-4"><div><label className={LABEL_STYLE}>C√≥digo</label><input className={INPUT_STYLE} value={editingFilial.codigo} onChange={e=>setEditingFilial({...editingFilial, codigo:e.target.value})}/></div><div><label className={LABEL_STYLE}>Nome</label><input className={INPUT_STYLE} value={editingFilial.nome_fantasia} onChange={e=>setEditingFilial({...editingFilial, nome_fantasia:e.target.value})}/></div><div className="col-span-2 flex gap-2"><button onClick={()=>mutationFilial.mutate(editingFilial)} className="bg-green-500 text-white px-4 py-2 rounded-lg font-bold">Salvar</button><button onClick={()=>setEditingFilial(null)} className="bg-slate-300 text-slate-700 px-4 py-2 rounded-lg font-bold">Cancelar</button></div></div>}<div className="grid grid-cols-1 md:grid-cols-2 gap-4">{filiais.map(f => (<div key={f.id} className="p-4 border-2 border-slate-100 rounded-xl flex justify-between items-center group hover:border-blue-200"><div><span className="font-bold text-slate-700 block">{f.nome_fantasia}</span><span className="text-xs font-black bg-slate-200 text-slate-500 px-2 py-0.5 rounded-lg">{f.codigo}</span></div><div className="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity"><button onClick={()=>setEditingFilial(f)} className="p-2 text-blue-500 hover:bg-blue-50 rounded-lg"><Edit2 size={18}/></button><button onClick={()=>{if(window.confirm("Excluir?")) mutationFilial.mutate({id: f.id}, {onSuccess: ()=>deletarFilial(f.id)})}} className="p-2 text-red-500 hover:bg-red-50 rounded-lg"><Trash2 size={18}/></button></div></div>))}</div></div>)}
        {currentView === 'fornecedores' && (<div className="bg-white rounded-3xl p-8 shadow-xl animate-in zoom-in-95"><div className="flex justify-between mb-6"><h2 className="text-3xl font-black text-[#1A2A6C] flex gap-3 items-center"><div className="bg-[#F9C531] p-2 rounded-lg text-white"><Users/></div> FORNECEDORES</h2><button onClick={()=>setEditingFornecedor({nome_empresa:'', lista_cnpjs:'', lista_contratos:'', lista_centro_custos:'', padrao_descricao_servico:'', padrao_servico_protheus:''})} className="bg-[#2196F3] text-white px-4 py-2 rounded-xl font-bold flex gap-2"><Plus size={18}/> Novo</button></div>{editingFornecedor && <div className="bg-slate-50 p-6 rounded-xl mb-6 border border-blue-200 grid grid-cols-2 gap-4"><div className="col-span-2"><label className={LABEL_STYLE}>Nome</label><input className={INPUT_STYLE} value={editingFornecedor.nome_empresa} onChange={e=>setEditingFornecedor({...editingFornecedor, nome_empresa:e.target.value})}/></div><div><label className={LABEL_STYLE}>CNPJs</label><input className={INPUT_STYLE} value={editingFornecedor.lista_cnpjs} onChange={e=>setEditingFornecedor({...editingFornecedor, lista_cnpjs:e.target.value})}/></div><div><label className={LABEL_STYLE}>Contratos</label><input className={INPUT_STYLE} value={editingFornecedor.lista_contratos} onChange={e=>setEditingFornecedor({...editingFornecedor, lista_contratos:e.target.value})}/></div><div className="col-span-2 flex gap-2"><button onClick={()=>mutationFornecedor.mutate(editingFornecedor)} className="bg-green-500 text-white px-4 py-2 rounded-lg font-bold">Salvar</button><button onClick={()=>setEditingFornecedor(null)} className="bg-slate-300 text-slate-700 px-4 py-2 rounded-lg font-bold">Cancelar</button></div></div>}<div className="grid grid-cols-1 gap-4">{fornecedores.map(f => (<div key={f.id} className="p-5 border-2 border-slate-100 rounded-xl hover:border-[#1A2A6C] transition-colors group flex justify-between items-start"><div className="flex-1"><h3 className="font-black text-lg text-[#1A2A6C] mb-2">{f.nome_empresa}</h3><div className="grid grid-cols-2 gap-4 text-xs text-slate-500"><div><strong className="block uppercase text-slate-400">Contratos</strong>{f.lista_contratos}</div><div><strong className="block uppercase text-slate-400">Centro de Custo</strong>{f.lista_centro_custos}</div></div></div><div className="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity ml-4"><button onClick={()=>setEditingFornecedor(f)} className="p-2 text-blue-500 hover:bg-blue-50 rounded-lg"><Edit2 size={18}/></button><button onClick={()=>{if(window.confirm("Excluir?")) axios.delete(`${API_URL}/fornecedores/${f.id}`, authConfig).then(()=>queryClient.invalidateQueries(['fornecedores']));}} className="p-2 text-red-500 hover:bg-red-50 rounded-lg"><Trash2 size={18}/></button></div></div>))}</div></div>)}
        {currentView === 'usuarios' && (<div className="grid grid-cols-1 lg:grid-cols-3 gap-8 animate-in zoom-in-95"><div className="lg:col-span-1 bg-white rounded-3xl p-8 shadow-xl h-fit"><h3 className="text-xl font-black text-[#1A2A6C] mb-4">NOVO USU√ÅRIO</h3><div className="space-y-4"><div><label className={LABEL_STYLE}>Nome</label><input className={INPUT_STYLE} value={formUser.nome_completo} onChange={e=>setFormUser({...formUser, nome_completo:e.target.value})}/></div><div><label className={LABEL_STYLE}>Login</label><input className={INPUT_STYLE} value={formUser.username} onChange={e=>setFormUser({...formUser, username:e.target.value})}/></div><div><label className={LABEL_STYLE}>Senha</label><input type="password" className={INPUT_STYLE} value={formUser.password} onChange={e=>setFormUser({...formUser, password:e.target.value})}/></div><button onClick={criarUsuario} className={`w-full ${BUTTON_PRIMARY} mt-4`}>CADASTRAR</button></div></div><div className="lg:col-span-2 bg-white rounded-3xl p-8 shadow-xl"><h3 className="text-xl font-black text-[#1A2A6C] mb-6">USU√ÅRIOS ATIVOS</h3><div className="space-y-4">{usuarios.map(u => (<div key={u.id} className="flex items-center justify-between p-4 border border-slate-100 rounded-xl bg-slate-50"><div className="flex items-center gap-4"><div className="bg-[#1A2A6C] text-white h-10 w-10 rounded-full flex items-center justify-center font-bold text-lg">{u.nome_completo.charAt(0)}</div><div><p className="font-bold text-[#1A2A6C]">{u.nome_completo}</p><p className="text-xs text-slate-400 font-bold uppercase">{u.cargo} ‚Ä¢ {u.setor}</p></div></div><span className="text-xs bg-emerald-100 text-emerald-700 px-3 py-1 rounded-full font-bold">ATIVO</span></div>))}</div></div></div>)}
      </main>

      <footer className="fixed bottom-0 left-0 right-0 h-[100px] bg-gradient-to-r from-[#F9C531] via-[#F77F00] to-[#D62828] z-10 flex flex-col items-center justify-center shadow-[0_-10px_40px_rgba(0,0,0,0.1)] -mb-16 hover:mb-0 transition-all duration-300 group"><div className="w-full h-[1px] bg-white/20 mb-3"></div><div className="text-center"><h3 className="text-white/60 font-black text-xl uppercase tracking-[0.5em] group-hover:text-white transition-colors duration-300">Cicopal</h3><p className="text-white/60 text-[10px] font-bold mt-1 uppercase tracking-widest"></p></div><div className="absolute top-[-15px] left-1/2 -translate-x-1/2 bg-white p-1.5 rounded-full shadow-lg cursor-pointer group-hover:translate-y-1 transition-transform"><ArrowRight className="-rotate-90 text-[#F77F00]" size={16}/></div></footer>
      {/* MODAL MANTIDO (Igual ao anterior, sem mudan√ßas) */}
      {showModal && (
        <div className="fixed inset-0 bg-[#1A2A6C]/60 backdrop-blur-md z-[70] flex items-center justify-center p-4">
          <div className="bg-white rounded-[32px] shadow-2xl w-full max-w-5xl h-[85vh] flex flex-col overflow-hidden animate-in zoom-in-95 duration-200 border border-white/50">
             <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h2 className="text-2xl font-black flex gap-3 text-[#1A2A6C] items-center tracking-tight"><div className="bg-[#1A2A6C] p-2 rounded-xl text-white shadow-lg"><Plus size={24}/></div>{isEditMode ? 'EDITAR LAN√áAMENTO' : 'NOVO LAN√áAMENTO'}</h2>
                <button onClick={() => setShowModal(false)} className="text-slate-400 hover:text-[#D62828] bg-white hover:bg-red-50 p-2 rounded-full transition-all shadow-sm"><X size={24}/></button>
             </div>
             <div className="flex-1 overflow-y-auto p-8 space-y-8 bg-white">
                 <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div className="md:col-span-1"><label className={LABEL_STYLE}>Filial</label><select className={INPUT_STYLE} value={form.filial_id} onChange={e => setForm({...form, filial_id: e.target.value})}><option>Selecione...</option>{filiais.map(f => <option key={f.id} value={f.id}>{f.codigo} - {f.nome_fantasia}</option>)}</select></div>
                    <div className="md:col-span-1"><label className={LABEL_STYLE}>Fornecedor</label><select className={INPUT_STYLE} value={form.fornecedor_id} onChange={e => handleFornecedorChange(e.target.value)}><option>Selecione...</option>{fornecedores.map(f => <option key={f.id} value={f.id}>{f.nome_empresa}</option>)}</select></div>
                    <div className="md:col-span-2 grid grid-cols-2 gap-4 bg-slate-50 p-4 rounded-xl border border-slate-100">
                       <div className="col-span-2"><label className={LABEL_STYLE}>Centro de Custo</label><select className={`${INPUT_STYLE} !bg-white`} value={form.centro_custo_usado} onChange={e => setForm({...form, centro_custo_usado: e.target.value})}><option value="">Selecione...</option>{opcoesFornecedor.ccs.map(opt => <option key={opt} value={opt}>{opt}</option>)}</select></div>
                       <div><label className={LABEL_STYLE}>CNPJ</label><select className={`${INPUT_STYLE} !bg-white text-xs`} value={form.cnpj_usado} onChange={e => setForm({...form, cnpj_usado: e.target.value})}><option value="">Selecione...</option>{opcoesFornecedor.cnpjs.map(opt => <option key={opt} value={opt}>{opt}</option>)}</select></div>
                       <div><label className={LABEL_STYLE}>Contrato</label><select className={`${INPUT_STYLE} !bg-white text-xs`} value={form.contrato_usado} onChange={e => setForm({...form, contrato_usado: e.target.value})}><option value="">Selecione...</option>{opcoesFornecedor.contratos.map(opt => <option key={opt} value={opt}>{opt}</option>)}</select></div>
                    </div>
                    <div className="col-span-4 h-[1px] bg-slate-100 rounded-full"></div>
                    <div><label className={LABEL_STYLE}>N¬∫ Nota *</label><input className={INPUT_STYLE} value={form.numero_nota} onChange={e => setForm({...form, numero_nota: e.target.value})}/></div>
                    <div><label className={LABEL_STYLE}>S√©rie</label><input className={INPUT_STYLE} placeholder="U" value={form.serie} onChange={e => setForm({...form, serie: e.target.value})}/></div>
                    <div><label className={LABEL_STYLE}>Valor (R$) *</label><input type="number" className={INPUT_STYLE} value={form.valor} onChange={e => setForm({...form, valor: e.target.value})}/></div>
                    <div><label className={LABEL_STYLE}>Status Inicial</label><select className={INPUT_STYLE} value={form.status_pagamento} onChange={e => setForm({...form, status_pagamento: e.target.value})}>{OPCOES_STATUS.map(s => <option key={s} value={s}>{s}</option>)}</select></div>
                    <div><label className={LABEL_STYLE}>Data Envio TI</label><input type="date" className={INPUT_STYLE} value={form.data_envio || ''} onChange={e => setForm({...form, data_envio: e.target.value})}/></div>
                    <div><label className={LABEL_STYLE}>Vencimento *</label><input type="date" className={INPUT_STYLE} value={form.data_vencimento} onChange={e => setForm({...form, data_vencimento: e.target.value})}/></div>
                    <div className="col-span-2"></div>
                    <div className="col-span-4 bg-[#F9C531]/10 p-6 rounded-2xl border border-[#F9C531]/30 grid grid-cols-3 gap-6">
                        <div className="col-span-3 flex items-center gap-2 text-[#F77F00] mb-2"><Server size={18}/> <span className="text-xs font-black uppercase tracking-widest">Controle Interno</span></div>
                        <div><label className={LABEL_STYLE}>Medi√ß√£o</label><input className={INPUT_STYLE} value={form.numero_medicao} onChange={e => setForm({...form, numero_medicao: e.target.value})}/></div>
                        <div><label className={LABEL_STYLE}>Pedido</label><input className={INPUT_STYLE} value={form.numero_pedido} onChange={e => setForm({...form, numero_pedido: e.target.value})}/></div>
                        <div><label className={LABEL_STYLE}>Fluig</label><input className={INPUT_STYLE} value={form.solicitacao_fluig} onChange={e => setForm({...form, solicitacao_fluig: e.target.value})}/></div>
                        <div className="col-span-3 grid grid-cols-2 gap-6">
                            <div><label className={LABEL_STYLE}>Descri√ß√£o Servi√ßo</label><input className={INPUT_STYLE} value={form.descricao_servico} onChange={e => setForm({...form, descricao_servico: e.target.value})}/></div>
                            <div><label className={LABEL_STYLE}>Servi√ßo Protheus</label><input className={INPUT_STYLE} value={form.servico_protheus} onChange={e => setForm({...form, servico_protheus: e.target.value})}/></div>
                        </div>
                    </div>
                    <div className="col-span-2"><FileDrop label="ANEXAR NOTA FISCAL" colorTheme="red" onFileSelect={path => setForm({...form, arquivo_nota: path})} existingFile={form.arquivo_nota} metaData={{fornecedor: nomeFornecedorAtual, nota: form.numero_nota, vencimento: form.data_vencimento}}/></div>
                    <div className="col-span-2"><FileDrop label="ANEXAR BOLETO" colorTheme="blue" onFileSelect={path => setForm({...form, arquivo_boleto: path})} existingFile={form.arquivo_boleto} metaData={{fornecedor: nomeFornecedorAtual, nota: form.numero_nota, vencimento: form.data_vencimento}}/></div>
                    <div className="col-span-4"><label className={LABEL_STYLE}>Observa√ß√µes</label><textarea className={`${INPUT_STYLE} h-24 resize-none`} value={form.observacao} onChange={e => setForm({...form, observacao: e.target.value})}/></div>
                 </div>
             </div>
             <div className="p-6 border-t border-slate-100 bg-slate-50 shrink-0 flex justify-end gap-4">
                <button onClick={() => setShowModal(false)} className="px-8 py-3 rounded-xl font-bold text-slate-400 hover:text-[#D62828] hover:bg-white transition-colors uppercase tracking-wider text-sm">Cancelar</button>
                <button onClick={salvarForm} className="bg-gradient-to-r from-[#1A2A6C] to-[#2196F3] hover:scale-105 text-white font-black px-10 py-3 rounded-xl shadow-xl shadow-blue-500/20 transition-all active:scale-95 flex items-center gap-3 uppercase tracking-wider text-sm"><CheckCircle size={20}/> SALVAR</button>
             </div>
          </div>
        </div>
      )}
    </div>
  );
}